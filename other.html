<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>p5.js Video Capture with Facial Recognition</title>
  <!-- Include p5.js from a CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/addons/p5.sound.min.js"></script>
</head>
<body>
   <!-- Play/Pause Button -->
  <button id="audio" onclick="toggleAudio()">Play</button>

  <!-- Main p5.js Script -->
  <script>

    let threshold = 100; // Set a threshold for loudness (tweak as needed)

function preload() {
  song = loadSound("away.mp3");
  playing = false;
  song.onended(() => {
    playing = false;
    document.getElementById("audio").innerText = "Play";
    a = 0;
  });
  fr = 60;
}

function setup() {
  createCanvas(500, 500);
  layer = createGraphics(width, height);

  background("black");

  fft = new p5.FFT(0, 256);

  a = 360 / (song.duration() * fr);
  b = a;

  frameRate(fr);
}

function draw() {
  background(0);

  layer.noFill();
  layer.colorMode(RGB);

  var spectrumA = fft.analyze();
  var spectrumB = spectrumA.reverse(); // Reverse the spectrum
  spectrumB.splice(0, 40); // Remove unwanted low frequencies

  push();
  translate(250, 250);
  noFill();
  stroke("white");

  beginShape();

  // Draw only for loud beats
  for (let i = 0; i < spectrumB.length; i++) {
    if (spectrumB[i] > threshold) { // Check if the amplitude is above the threshold
      var amp = spectrumB[i];
      var x = map(amp, 0, 256, -2, 2);
      var y = map(i, 0, spectrumB.length, 30, 215);

      vertex(x, y); // Draw the shape based on louder beats
    }
  }

  endShape();

  pop();

  push();

  translate(width / 2, height / 2);
  rotate(radians(a));

  layer.push();
  layer.translate(width / 2, height / 2);
  layer.rotate(radians(-a));

  // Draw only for loud beats
  for (let i = 0; i < spectrumB.length; i++) {
    if (spectrumB[i] > threshold) { // Check if the amplitude is above the threshold
      layer.strokeWeight(0.018 * spectrumB[i]);
      layer.stroke(255, 183, 294 - spectrumB[i], spectrumB[i] / 40);
      layer.line(0, i, 0, i);
    }
  }

  layer.pop();

  image(layer, -width / 2, -height / 2); // Display the final result

  pop();

  if (playing) a += b; // Rotate if playing
}

function toggleAudio() {
  if (!playing) {
    song.play();
    document.getElementById("audio").innerText = "Pause";
  } else {
    song.pause();
    document.getElementById("audio").innerText = "Play";
  }

  playing = !playing;
}
    </script>
    </body>
    </html>
